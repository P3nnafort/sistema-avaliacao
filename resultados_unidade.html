<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Avaliações Externas">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.145.0">
    <title>Resultados - Unidade</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Importando a fonte Montserrat do Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">

    <!-- Favicons -->
    <link rel="apple-touch-icon" href="../assets/img/favicons/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" href="../assets/img/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="../assets/img/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="manifest" href="../assets/img/favicons/manifest.json">
    <link rel="mask-icon" href="../assets/img/favicons/safari-pinned-tab.svg" color="#712cf9">
    <link rel="icon" href="../assets/img/favicons/favicon.ico">
    <meta name="theme-color" content="#712cf9">

    <style>
        /* Estilo do background responsivo */
        body {
            text-align: center;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-image: url('/static/background.png');
            background-size: 100% 100vh;
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Ajuste para melhorar o contraste do conteúdo com o fundo */
        main {
            background-color: rgba(255, 255, 255, 0.027);
            border-radius: 10px;
            padding: 20px;
            flex-grow: 1;
            width: 100%;
        }

        /* Header ajustado */
        header {
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.175);
            width: 100%;
        }

        header a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: inherit;
        }

        .header-img {
            max-height: 75px;
            width: auto;
        }

        .header-img-secondary {
            max-height: 50px;
            width: auto;
        }

        @media (max-width: 576px) {
            .header-img {
                max-height: 40px;
            }
            .header-img-secondary {
                max-height: 20px;
            }
        }

        .montserrat-bold {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
        }

        /* Ajuste fino para centralizar mais os itens do header */
        .header-container {
            padding-left: 40px; /* Reduz o espaço à esquerda */
            padding-right: 40px; /* Reduz o espaço à direita */
        }

        /* Conteúdo */
        .content {
            margin-top: 60px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 0 15px; /* Adiciona padding lateral para telas pequenas */
        }

        select {
            margin: 10px;
            padding: 5px;
            width: 100%;
            max-width: 300px;
        }

        /* Estilo dos botões ajustado para .btn-primary */
        .btn-primary {
            margin: 10px;
            padding: 5px;
            width: 100%;
            max-width: 300px;
        }

        .tabela-container {
            width: 100%;
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            max-width: 100%; /* Permite que a tabela se ajuste à largura disponível */
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            white-space: normal; /* Permite quebra de linha */
            word-wrap: break-word; /* Quebra palavras longas */
        }

        th {
            background-color: #f0f0f0;
        }

        #resumo {
            margin: 10px 0;
            text-align: left;
            width: 100%;
            max-width: 600px;
        }

        /* Div para o label "Resultados - Unidade" */
        .resultados-label {
            margin-bottom: 40px;
            margin-top: -20px;
        }

        /* Media queries para responsividade */
        @media (max-width: 768px) {
            .content {
                padding: 0 10px;
            }
            select, .btn-primary {
                max-width: 100%; /* Usa toda a largura disponível em telas menores */
            }
            #resumo {
                max-width: 100%;
            }
        }

        @media (max-width: 576px) {
            .content {
                margin-top: 30px; /* Reduz margem superior em telas pequenas */
            }
            th, td {
                font-size: 10px; /* Reduz fonte para caber melhor */
                padding: 4px; /* Reduz padding */
            }
        }
    </style>
</head>

<body>
    <main>
        <div class="container py-4 header-container">
            <!-- Header ajustado com padding para centralizar mais -->
            <header class="pb-3 mb-4 border-bottom">
                <a href="/" class="d-flex align-items-center text-body-emphasis text-decoration-none">
                    <img src="/static/logo2.png" alt="Logo" class="me-2 header-img">
                    <span class="fs-4 montserrat-bold">Sistema de Avaliações Externas - Digital</span>
                    <img src="/static/logo1.png" alt="Outra Imagem" class="ms-auto header-img-secondary">
                </a>
            </header>

            <div class="content">
                <div class="resultados-label">
                    <label class="montserrat-bold">Resultados - Unidade</label>
                </div>
                <select id="avaliacao">
                    <option value="">Todas as Avaliações</option>
                </select>
                <select id="etapa" onchange="carregarTurmas()">
                    <option value="">Todas as Etapas</option>
                </select>
                <select id="turma">
                    <option value="">Todas as Turmas</option>
                </select>
                <button class="btn btn-primary" onclick="carregarResultados()">Filtrar</button>
                
                <div id="resumo">
                    <p>Participantes: <span id="participantes">0</span></p>
                    <p>Ausentes: <span id="ausentes">0</span></p>
                    <p>Média Língua Portuguesa: <span id="media_portugues">0%</span></p>
                    <p>Média Matemática: <span id="media_matematica">0%</span></p>
                </div>
                
                <div class="tabela-container">
                    <table id="tabelaResultados">
                        <thead id="tabelaCabecalho"></thead>
                        <tbody id="tabelaCorpo"></tbody>
                    </table>
                </div>
                <button class="btn btn-primary" onclick="voltar()">Voltar</button>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Script ajustado -->
    <script>
        let unidadeAtual = null;
        let cpfValido = null;
        let questoes = [];

        async function inicializar() {
            const urlParams = new URLSearchParams(window.location.search);
            cpfValido = urlParams.get("cpf");
            if (!cpfValido) {
                alert("Acesso não autorizado. Por favor, faça login.");
                window.location.href = '/opcoes_unidade.html';
                return;
            }
            try {
                const response = await fetch("/verificar_cpf_unidade", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ cpf: cpfValido })
                });
                const data = await response.json();
                if (data.status === "success") {
                    unidadeAtual = data.unidade;
                    await carregarFiltros();
                    // Não chamar carregarResultados() aqui diretamente
                } else {
                    alert("Erro ao carregar unidade: " + data.message);
                    window.location.href = '/opcoes_unidade.html';
                }
            } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao conectar ao servidor.");
            }
        }

        async function carregarFiltros() {
            try {
                const response = await fetch(`/resultados_unidade?unidade=${unidadeAtual}`);
                const data = await response.json();
                
                const avaliacaoSelect = document.getElementById("avaliacao");
                avaliacaoSelect.innerHTML = '<option value="">Todas as Avaliações</option>';
                data.avaliacoes.forEach(avaliacao => {
                    avaliacaoSelect.innerHTML += `<option value="${avaliacao}">${avaliacao}</option>`;
                });
                
                const etapaSelect = document.getElementById("etapa");
                etapaSelect.innerHTML = '<option value="">Todas as Etapas</option>';
                data.etapas.forEach(etapa => {
                    etapaSelect.innerHTML += `<option value="${etapa}">${etapa}</option>`;
                });
                
                const turmaSelect = document.getElementById("turma");
                turmaSelect.innerHTML = '<option value="">Todas as Turmas</option>';
                data.turmas.forEach(turma => {
                    turmaSelect.innerHTML += `<option value="${turma}">${turma}</option>`;
                });
            } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao carregar filtros.");
            }
        }

        async function carregarTurmas() {
            const etapa = document.getElementById("etapa").value;
            try {
                const response = await fetch(`/resultados_unidade?unidade=${unidadeAtual}${etapa ? '&etapa=' + etapa : ''}`);
                const data = await response.json();
                
                const turmaSelect = document.getElementById("turma");
                turmaSelect.innerHTML = '<option value="">Todas as Turmas</option>';
                data.turmas.forEach(turma => {
                    turmaSelect.innerHTML += `<option value="${turma}">${turma}</option>`;
                });
            } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao carregar turmas.");
            }
        }

        async function carregarResultados() {
            const avaliacao = document.getElementById("avaliacao").value;
            const etapa = document.getElementById("etapa").value;
            const turma = document.getElementById("turma").value;
            
            let url = `/resultados_unidade?unidade=${unidadeAtual}`;
            if (avaliacao) url += `&nome_avaliacao=${avaliacao}`;
            if (etapa) url += `&etapa=${etapa}`;
            if (turma) url += `&turma=${turma}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                questoes = data.questoes;
                const cabecalho = document.getElementById("tabelaCabecalho");
                const corpo = document.getElementById("tabelaCorpo");

                if (!cabecalho || !corpo) {
                    throw new Error("Elementos da tabela não encontrados no DOM");
                }

                let cabecalhoHtml = `
                    <tr>
                        <th>Matrícula</th>
                        <th>Nome</th>
                        <th>Etapa</th>
                        <th>Turma</th>
                        <th>Avaliação</th>
                        <th>Português (%)</th>
                        <th>Matemática (%)</th>
                `;
                questoes.forEach((q, i) => {
                    cabecalhoHtml += `<th>Q${i + 1} (${q.habilidade})</th>`;
                });
                cabecalhoHtml += `</tr>`;
                cabecalho.innerHTML = cabecalhoHtml;

                if (data.resultados.length === 0) {
                    corpo.innerHTML = `<tr><td colspan="${7 + questoes.length}">Nenhum resultado encontrado.</td></tr>`;
                } else {
                    let html = "";
                    data.resultados.forEach(resultado => {
                        html += `
                            <tr>
                                <td>${resultado.matricula}</td>
                                <td>${resultado.nome}</td>
                                <td>${resultado.etapa}</td>
                                <td>${resultado.turma}</td>
                                <td>${resultado.nome_avaliacao || "Sem Avaliação"}</td>
                                <td>${resultado.portugues_porcentagem.toFixed(2)}%</td>
                                <td>${resultado.matematica_porcentagem.toFixed(2)}%</td>
                        `;
                        questoes.forEach((q, i) => {
                            const resposta = resultado.respostas && resultado.respostas[`q${i}`] ? resultado.respostas[`q${i}`].toUpperCase() : "-";
                            html += `<td>${resposta}</td>`;
                        });
                        html += `</tr>`;
                    });
                    corpo.innerHTML = html;
                }

                document.getElementById("participantes").innerText = data.participantes;
                document.getElementById("ausentes").innerText = data.ausentes;
                document.getElementById("media_portugues").innerText = data.media_portugues.toFixed(2) + "%";
                document.getElementById("media_matematica").innerText = data.media_matematica.toFixed(2) + "%";
            } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao carregar resultados: " + error.message);
            }
        }

        function voltar() {
            window.location.href = `/opcoes_unidade.html?cpf=${cpfValido}`;
        }

        window.onload = async function() {
            await inicializar();
            await carregarResultados(); // Chama após inicializar
        };
    </script>
</body>
</html>